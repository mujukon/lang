<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ÁøªË®≥ÊºîÁøí</title>
<style>
body{
  position: relative;
  width: 100%;
  text-align: center;
  margin: 0;
  padding: 0;
}
#question { font-size: 50px; margin: 5px; }
#img { position: relative; z-index: -1; transform: scale(2); margin: 5px; }
button {
  margin: 15px;
  font-size: 60px;
  background-color: #fefefe;
  border: 2px solid #ddd;
  border-radius: 20px;
  box-shadow: 2px 1px 2px gray
}
#answerBox {
  min-height: 100px;
  border: 1px solid #aaa;
  padding: 6px;
  margin: 30px 5px 5px 20px;
  font-size: 50px;
}
#bottomBar {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 10px;
  background: white;
  border-top: 1px solid #ccc;
  z-index: 10;
}
.correct { color: green; font-size: 50px; }
#progress { color: green; font-size: 50px; }
.wrong { color: red; font-size: 50px; }
.locked { opacity: 0.4; }
</style>
</head>
<body>

<h2>ÁøªË®≥ÊºîÁøí</h2>

<div id=""><h2 id="progress"></h2></div>

<div id="center">
  <div><img id="img" src="pic/1.gif"></div>
  <div id="question"></div>
  <div id="result"></div>
  <div id="answerBox"></div>
  <div id="wordButtons"></div>

  <div id="langSelect"><div id="langButtons"></div></div>
  <div id="courseSelect" style="display:none;"><div id="courseButtons"></div></div>

  <button id="backBtn" style="display:none;">‚Üê ÂçòË™ûÂâäÈô§</button>
</div>

<div id="bottomBar">
  <button id="backLangBtn" style="display:none;">Ë®ÄË™ûÈÅ∏Êäû„Å´Êàª„Çã</button>
  <button id="checkBtn" style="display:none;">Á≠î„ÅàÂêà„Çè„Åõ</button>
  <button id="nextBtn" style="display:none;">Ê¨°„Å∏</button>
</div>

<script src="data.js"></script>
<script>
/* =========================
   „Éá„Éº„ÇøËß£ÊûêÔºàË®ÄË™û‚Üí„Ç≥„Éº„Çπ‚ÜíÊñáÔºâ
========================= */

const langs = [];
const coursesByLang = [];
let currentLang = -1;
let currentCourse = -1;

sentenceText.split("\n").forEach(line => {
  line = line.trim();
  if (!line) return;

  if (line.startsWith("*")) {
    langs.push(line.slice(1).trim());
    coursesByLang.push([]);
    currentLang++;
    currentCourse = -1;
    return;
  }

  if (line.startsWith(">")) {
    coursesByLang[currentLang].push({
      name: line.slice(1).trim(),
      sentences: []
    });
    currentCourse++;
    return;
  }

  coursesByLang[currentLang][currentCourse].sentences.push(line);
});

/* =========================
   Áä∂ÊÖãÁÆ°ÁêÜ
========================= */

let state = { lang: 0, course: 0 };
let poolJP = [], poolLang = [];
let currentWords = [], buttons = [];
let correctAnswers = [];
let questionQueue = []; // Êú™Ê≠£Ëß£ÂïèÈ°å„Ç≠„É•„Éº
let total = 0;//„Åù„ÅÆ„Ç≥„Éº„Çπ„ÅÆÂïèÈ°åÊï∞
/* =========================
   ÈÄ≤ÊçóÔºàlocalStorageÔºâ
========================= */

const STORAGE_KEY = "courseProgress_v1";
let courseProgress = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");

function getProgressKey(lang, course) {
  return lang + "-" + course;
}

function getClearCount(lang, course) {
  return courseProgress[getProgressKey(lang, course)] || 0;
}

function addClear(lang, course) {
  const key = getProgressKey(lang, course);
  courseProgress[key] = getClearCount(lang, course) + 1;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(courseProgress));
}

/* =========================
   ÂçòË™û„Éó„Éº„É´ÊßãÁØâ
========================= */

function buildWordPool() {
  const setJP = new Set();
  const setLang = new Set();

  const sentences = coursesByLang[state.lang][state.course].sentences;

  sentences.forEach(line => {
    const [lang, jpRaw] = line.split("\t");
    const jps = jpRaw.split("/");

    lang.split(" ").forEach(w => setLang.add(w));
    jps.forEach(j => j.split(" ").forEach(w => setJP.add(w)));
  });

  poolJP = [...setJP];
  poolLang = [...setLang];
}

/* =========================
   „Ç≥„Éº„ÇπÈñãÂßãÔºà„Ç≠„É•„ÉºÁîüÊàêÔºâ
========================= */

function startCourse() {
  const sentences = coursesByLang[state.lang][state.course].sentences;
  questionQueue = [...sentences].sort(() => Math.random() - 0.5);
  total = questionQueue.length;
  loadQuestion();
}

/* =========================
   ÂïèÈ°åË°®Á§∫Ôºà„Ç≠„É•„ÉºÊñπÂºèÔºâ
========================= */

function loadQuestion() {
  if (questionQueue.length === 0) {
    finishCourse();
    return;
  }
  progress();
  const line = questionQueue[0];
  const [lang, jpRaw] = line.split("\t");
  const jps = jpRaw.split("/");

  let mode = "jp2lang"
  if (getClearCount(state.lang, state.course)%2==0){mode = "lang2jp"}
  
  let questionText, answers, pool;
  
  if (mode === "jp2lang") {
    questionText = jps[0];
    answers = [lang];
    pool = poolLang;
  } else {
    questionText = lang;
    answers = jps;
    pool = poolJP;
  }

  correctAnswers = answers;
  currentWords = [];
  buttons = [];
  document.getElementById("progress").style.display = "inline";
  document.getElementById("result").textContent = "";
  document.getElementById("answerBox").textContent = "";
  document.getElementById("wordButtons").innerHTML = "";
  document.getElementById("checkBtn").style.display = "inline";
  document.getElementById("nextBtn").style.display = "none";
  document.getElementById("backBtn").style.display = "inline";

  document.getElementById("question").innerHTML =
    "„Äê" + langs[state.lang] + " / " + coursesByLang[state.lang][state.course].name + "„Äë<br>" + questionText;

  let words = [];
  answers.forEach(ans => ans.split(" ").forEach(w => words.push(w)));

  while (words.length < Math.min(pool.length, 12)) {
    words.push(pool[Math.floor(Math.random() * pool.length)]);
  }

  words.sort(() => Math.random() - 0.5);

  const area = document.getElementById("wordButtons");
  words.forEach(word => {
    const btn = document.createElement("button");
    btn.textContent = word;
    btn.onclick = () => {
      currentWords.push(word);
      btn.style.display = "none";
      buttons.push(btn);
      updateAnswer();
    };
    area.appendChild(btn);
  });

  document.getElementById("img").src = "pic/" + Math.floor(Math.random()*7) + ".gif";
}

/* =========================
   Ëß£Á≠îË°®Á§∫
========================= */

function updateAnswer() {
  document.getElementById("answerBox").textContent = currentWords.join(" ");
}

/* =========================
   ÂçòË™ûÂâäÈô§
========================= */

document.getElementById("backBtn").onclick = () => {
  if (currentWords.length === 0) return;
  const removed = currentWords.pop();
  const btn = buttons.find(b => b.textContent === removed && b.style.display === "none");
  if (btn) btn.style.display = "";
  updateAnswer();
};

/* =========================
   Âà§ÂÆöÔºà„Ç≠„É•„ÉºÂà∂Âæ°Ôºâ
========================= */

document.getElementById("checkBtn").onclick = () => {
  const userAnswer = currentWords.join(" ");
  const ok = correctAnswers.includes(userAnswer);

  const result = document.getElementById("result");
  
  if (ok) {
    result.textContent = "‚úÖ Ê≠£Ëß£";
    result.className = "correct";

    // Ê≠£Ëß£ ‚Üí „Ç≠„É•„Éº„Åã„ÇâÂâäÈô§
    questionQueue.shift();
  } else {
    result.textContent = "‚ùå ‰∏çÊ≠£Ëß£\nÊ≠£Ëß£: " + correctAnswers.join(" / ");
    result.className = "wrong";

    // ‰∏çÊ≠£Ëß£ ‚Üí Âæå„Çç„Å´Âõû„Åô
    questionQueue.push(questionQueue.shift());
  }
  progress();
  document.getElementById("checkBtn").style.display = "none";
  document.getElementById("nextBtn").style.display = "inline";
};

document.getElementById("nextBtn").onclick = () => {
  loadQuestion();
};

/* =========================
   „Ç≥„Éº„Çπ„ÇØ„É™„Ç¢Âá¶ÁêÜ
========================= */

function finishCourse() {
  addClear(state.lang, state.course);
  const count = getClearCount(state.lang, state.course);

  document.getElementById("question").textContent =
    "üéâ „Ç≥„Éº„Çπ„ÇØ„É™„Ç¢ÔºÅ (" + count + "/2)";
  document.getElementById("wordButtons").innerHTML = "";
  document.getElementById("answerBox").textContent = "";
  document.getElementById("checkBtn").style.display = "none";
  document.getElementById("nextBtn").style.display = "none";

  updateCourseButtons();
}

/* =========================
   Ë®ÄË™û„Éª„Ç≥„Éº„ÇπÈÅ∏ÊäûUI
========================= */

function updateLangButtons() {
  const area = document.getElementById("langButtons");
  area.innerHTML = "";

  langs.forEach((name, i) => {
    const btn = document.createElement("button");
    btn.textContent = name;
    btn.onclick = () => selectLanguage(i);
    area.appendChild(btn);
  });
}

function updateCourseButtons() {
  const area = document.getElementById("courseButtons");
  area.innerHTML = "";

  const courses = coursesByLang[state.lang];

  courses.forEach((c, i) => {
    const btn = document.createElement("button");
    const cleared = getClearCount(state.lang, i);
    const locked = i > 0 && getClearCount(state.lang, i-1) < 2;

    btn.textContent = c.name + " (" + cleared + "/2)";
    if (locked) {
      btn.classList.add("locked");
      btn.textContent = "üîí " + btn.textContent;
      btn.disabled = true;
    } else {
      btn.onclick = () => selectCourse(i);
    }

    area.appendChild(btn);
  });
}

function selectLanguage(idx) {
  state.lang = idx;
  document.getElementById("langSelect").style.display = "none";
  document.getElementById("courseSelect").style.display = "block";
  document.getElementById("backLangBtn").style.display = "inline";
  updateCourseButtons();
}

function selectCourse(idx) {
  state.course = idx;
  document.getElementById("courseSelect").style.display = "none";
  buildWordPool();
  startCourse();
}

/* =========================
   Êàª„Çã„Éú„Çø„É≥
========================= */

document.getElementById("backLangBtn").onclick = () => {
  document.getElementById("courseSelect").style.display = "none";
  document.getElementById("langSelect").style.display = "block";
 document.getElementById("progress").style.display = "none"; document.getElementById("backLangBtn").style.display = "none";
  document.getElementById("question").textContent = "";
  document.getElementById("wordButtons").innerHTML = "";
};

function progress(){
 var txt ="";
 var q = questionQueue.length;
 for (let i=0;i<10;i++){
  if(1-q/total>i/10){
   txt = txt+"‚ñ†"
  }else{
   txt=txt+"‚ñ°"  
  }
 }
  txt=txt+(100-Math.floor(q/total*100))+"%"
  document.getElementById("progress").textContent = txt;
}

/* =========================
   ÂàùÊúüÂåñ
========================= */

updateLangButtons();
</script>
</body>
</html>