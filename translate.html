<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>翻訳演習</title>
<style>
body{
  position: relative;
  width: 100%;
  text-align: center;
  margin: 0;
  padding: 0;
}
#question {
  font-size: 50px;
  margin: 5px;
}
#img {
position: relative;
  z-index: -1;
  transform: scale(2);
  margin: 5px;
}
button {
  margin: 15px;
  font-size: 60px;
  background-color: #fefefe;
  border: 2px solid #ddd;
  border-radius: 20px;
  box-shadow: 2px 1px 2px gray
}
#wordButtons{
  
  font-size: 60px;
}
#answerBox {
  min-height: 100px;
  border: 1px solid #aaa;
  padding: 6px;
  margin: 30px 5px 5px 20px;
  font-size: 50px;
}
#modeSelect {
  font-size: 50px;
   z-index: 10;
}
#bottomBar {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  padding: 0px;
  display: flex;
  justify-content: center;
  gap: 10px;
  background: white;
  border-top: 1px solid #ccc;
  z-index: 10;
}
#center {  
  top: 50%;
  width: 100%;
  text-align: center
}
#bottomBar button {
  font-size: 50px;
  padding: 30px 16px;
}

.correct { 
  color: green; 
         font-size: 50px;
}
.wrong { 
  color: red; 
       font-size: 50px;}
</style>
</head>
<body>

<h2>翻訳演習</h2>
<div id="topbar">
<select id="modeSelect">
  <option value="jp2lang">日本語 → 外国語</option>
  <option value="lang2jp">外国語 → 日本語</option>
</select>

</div>

<div id="center">
<div id="imgbox"><img id="img" src="pic/1.gif"></div>
<div id="question"></div>
<div id="result"></div>
  <div id="answerBox"></div>
  <div id="wordButtons"></div>
  <div id="langSelect">
    <div id="langButtons"></div>
  </div>
  <div id="courseSelect" style="display:none;">
  <div id="courseButtons"></div>
</div>

<button id="backBtn">← 単語削除</button>
</div>

<div id="bottomBar">
  <button id="backLangBtn" style="display:none;">言語選択に戻る</button>
  <button id="checkBtn" style="display:none;">答え合わせ</button>
  <button id="nextBtn" style="display:none;">次へ</button>
</div>




<script src="data.js"></script>


</body>
</html>
<script>
  let index = 0;
let currentWords = [];
let correctAnswers = [];
let poolJP = [];
let poolLang = [];
let buttons = [];
let mistake = -1;
let phase = "lang"; 
// "lang" → 言語選択
// "course" → コース選択
// "quiz" → クイズ

const langs = [];
const coursesByLang = [];

let currentLang = -1;
let currentCourse = -1;

sentenceText.split("\n").forEach(line => {
  line = line.trim();
  if (!line) return;

  // 言語
  if (line.startsWith("*")) {
    const langName = line.slice(1).trim();
    langs.push(langName);
    coursesByLang.push([]);
    currentLang++;
    currentCourse = -1;
    return;
  }

  // コース
  if (line.startsWith(">")) {
    const courseName = line.slice(1).trim();
    coursesByLang[currentLang].push({
      name: courseName,
      sentences: []
    });
    currentCourse++;
    return;
  }

  // 例文
  if (currentLang >= 0 && currentCourse >= 0) {
    coursesByLang[currentLang][currentCourse].sentences.push(line);
  }
});
let state = {
  lang: 0,
  course: 0
};




/* ===== 単語プール構築（言語別） ===== */
function buildWordPool() {
  const setJP = new Set();
  const setLang = new Set();

  const sentences = coursesByLang[state.lang][state.course].sentences;


  sentences.forEach(line => {
    const [lang, jpRaw] = line.split("\t");
    const jps = jpRaw.split("/");

    lang.split(" ").forEach(w => setLang.add(w));
    jps.forEach(j => j.split(" ").forEach(w => setJP.add(w)));
  });

  poolJP = [...setJP];
  poolLang = [...setLang];
}



/* ===== 問題生成 ===== */


function loadQuestion() {
 if (phase == "quiz"){
  const sentences = coursesByLang[state.lang][state.course].sentences;

  currentWords = [];
  buttons = [];

  document.getElementById("result").textContent = "";
  document.getElementById("answerBox").textContent = "";
  document.getElementById("wordButtons").innerHTML = "";
  document.getElementById("checkBtn").style.display = "inline";
  document.getElementById("nextBtn").style.display = "none";

  const mode = document.getElementById("modeSelect").value;

  const line = sentences[index % sentences.length];
  const [lang, jpRaw] = line.split("\t");
  const jps = jpRaw.split("/");

  let questionText, answers, pool;

  if (mode === "jp2lang") {
    questionText = jps[0];
    answers = [lang];
    pool = poolLang;
  } else {
    questionText = lang;
    answers = jps;
    pool = poolJP;
  }

  correctAnswers = answers;

  document.getElementById("question").innerHTML =
    "【" + langs[state.lang] + "】 <br>" + questionText;

  // 正解単語
  let words = [];
  
  answers.forEach(ans => ans.split(" ").forEach(w => words.push(w)));

  // ダミー単語（同じ言語側のみ）
  while (words.length < Math.min(pool.length, 12)) {
    const w = pool[Math.floor(Math.random() * pool.length)];
    words.push(w);
  }

  words = Array.from(words).sort(() => Math.random() - 0.5);

  const area = document.getElementById("wordButtons");

  words.forEach(word => {
    const btn = document.createElement("button");
    btn.textContent = word;

    btn.onclick = () => {
      currentWords.push(word);
      btn.style.display = "none"; // 消す
      buttons.push(btn);
      updateAnswer();
    };

    area.appendChild(btn);
  });
  var image = Math.floor(Math.random()*7);
  document.getElementById("img").src="pic/"+image+".gif"
  sizeChange();
 }
}


/* ===== 解答表示 ===== */

function updateAnswer() {
  document.getElementById("answerBox").textContent = currentWords.join(" ");
}


/* ===== 単語削除（ボタン復活） ===== */

document.getElementById("backBtn").onclick = () => {
  if (currentWords.length === 0) return;

  const removed = currentWords.pop();

  // 消えたボタンを復活
  const btn = buttons.find(b => b.textContent === removed && b.style.display === "none");
  if (btn) btn.style.display = "";

  updateAnswer();
};


/* ===== 判定 ===== */

document.getElementById("nextBtn").onclick = () => {
  if (mistake == -1){
    const sentences = coursesByLang[state.lang][state.course].sentences;

    index = Math.floor(Math.random() * sentences.length);
  }
  currentWords = [];
  loadQuestion();
};

document.getElementById("checkBtn").onclick = () => {
  const userAnswer = currentWords.join(" ");
  const ok = correctAnswers.includes(userAnswer);

  const result = document.getElementById("result");

  if (ok) {
    result.textContent = "✅ 正解";
    result.className = "correct";
    mistake = -1;
  } else {
    mistake = 1;
    result.textContent = "❌ 不正解 / 正解: " + correctAnswers.join(" / ");
    result.className = "wrong";
  }

  document.getElementById("checkBtn").style.display = "none";
  document.getElementById("nextBtn").style.display = "inline";
};


/* ===== 次へ ===== */


document.getElementById("modeSelect").onchange = loadQuestion;

let langPage = 0;

function updateCourseButtons() {
  const area = document.getElementById("courseButtons");
  area.innerHTML = "";

  const courses = coursesByLang[state.lang];

  courses.forEach((c, i) => {
    const btn = document.createElement("button");
    btn.textContent = c.name;
    btn.onclick = () => selectCourse(i);
    area.appendChild(btn);
  });
}


function updateLangButtons() {
  const base = langPage * 3;
  const area = document.getElementById("langButtons");
  area.innerHTML = "";
  
  for (let i = 0; i < langs.length; i++) {
    const idx = base + i;
    if (!langs[idx]) continue;

    const btn = document.createElement("button");
    btn.textContent = langs[idx];
    btn.onclick = () => {
      state.lang = idx;
      buildWordPool();
      const sentences = coursesByLang[state.lang][state.course].sentences;

      index = Math.floor(Math.random() * sentences.length);
      loadQuestion();
      selectLanguage(idx);
    };
    area.appendChild(btn);
  }
}

document.getElementById("backLangBtn").onclick = () => {

  if (phase === "quiz") {
    phase = "course";
    document.getElementById("courseSelect").style.display = "block";
    document.getElementById("question").textContent = "";
    document.getElementById("answerBox").textContent = "";
document.getElementById("checkBtn").style.display = "none";
document.getElementById("nextBtn").style.display = "none";
 document.getElementById("wordButtons").innerHTML = "";
    document.getElementById("result").textContent = "";
    return;
  }

  if (phase === "course") {
    phase = "lang";
    document.getElementById("courseSelect").style.display = "none";
    document.getElementById("langSelect").style.display = "block";
    document.getElementById("backLangBtn").style.display = "none";
document.getElementById("checkBtn").style.display = "none";
document.getElementById("nextBtn").style.display = "none";
  }
};



function selectLanguage(idx) {
  state.lang = idx;
  phase = "course";

  document.getElementById("langSelect").style.display = "none";
  document.getElementById("courseSelect").style.display = "block";

  updateCourseButtons();
}

function selectCourse(idx) {
  state.course = idx;
  phase = "quiz";

  document.getElementById("courseSelect").style.display = "none";
  document.getElementById("backLangBtn").style.display = "inline";

  buildWordPool();
  const sentences = coursesByLang[state.lang][state.course].sentences;
  index = Math.floor(Math.random() * sentences.length);
  loadQuestion();
}


updateLangButtons();
addEventListener("load", (event) => {sizeChange();});
function sizeChange(){
  if (screen.width > screen.height){
  var size = "30px"
  document.getElementById("question").style.fontSize = size;
  document.getElementById("answerBox").style.fontSize = size;
  document.getElementById("modeSelect").style.fontSize = size;
  document.getElementById("wordButtons").style.fontSize = size;
  document.getElementById("center").style.top="0%";
  document.querySelectorAll('button').forEach(btn => {
   btn.style.fontSize= size; 
   btn.style.margin= "5px"; 
  });
  document.getElementById("result").style.fontSize = size;
  }else{
  var size = "60px"
  document.getElementById("question").style.fontSize = size;
  document.getElementById("answerBox").style.fontSize = size;
  document.getElementById("modeSelect").style.fontSize = size;
  document.getElementById("wordButtons").style.fontSize = size;
  document.getElementById("center").style.top="50%";
  document.querySelectorAll('button').forEach(btn => {
   btn.style.fontSize= size; 
   btn.style.margin= "15px"; 
  });
  document.getElementById("result").style.fontSize = size;
  }
  if (screen.height < 500 || screen.width>screen.height){
   document.getElementById("img").style.transform= "scale(1)";
   document.getElementById("img").style.margin= "0px";
  }else{
    document.getElementById("img").style.transform= "scale(2)";
   document.getElementById("img").style.margin= "50px";
  }
}
window.addEventListener("resize", sizeChange);
</script>
