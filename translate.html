<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ç¿»è¨³æ¼”ç¿’</title>
<style>
body{
  position: relative;
  width: 100%;
  text-align: center;
  margin: 0;
  padding: 0;
}
#question { font-size: 50px; margin: 5px; }
#img { position: relative; z-index: -1; transform: scale(2); margin: 5px; }
button {
  margin: 15px;
  font-size: 60px;
  background-color: #fefefe;
  border: 2px solid #ddd;
  border-radius: 20px;
  box-shadow: 2px 1px 2px gray
}
#answerBox {
  min-height: 100px;
  border: 1px solid #aaa;
  padding: 6px;
  margin: 30px 5px 5px 20px;
  font-size: 50px;
}
#bottomBar {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 10px;
  background: white;
  border-top: 1px solid #ccc;
  z-index: 10;
}
.correct { color: green; font-size: 50px; }
.wrong { color: red; font-size: 50px; }
.locked { opacity: 0.4; }
</style>
</head>
<body>

<h2>ç¿»è¨³æ¼”ç¿’</h2>

<select id="modeSelect">
  <option value="jp2lang">æ—¥æœ¬èª â†’ å¤–å›½èª</option>
  <option value="lang2jp">å¤–å›½èª â†’ æ—¥æœ¬èª</option>
</select>

<div id="center">
  <div><img id="img" src="pic/1.gif"></div>
  <div id="question"></div>
  <div id="result"></div>
  <div id="answerBox"></div>
  <div id="wordButtons"></div>

  <div id="langSelect"><div id="langButtons"></div></div>
  <div id="courseSelect" style="display:none;"><div id="courseButtons"></div></div>

  <button id="backBtn" style="display:none;">â† å˜èªå‰Šé™¤</button>
</div>

<div id="bottomBar">
  <button id="backLangBtn" style="display:none;">è¨€èªé¸æŠã«æˆ»ã‚‹</button>
  <button id="checkBtn" style="display:none;">ç­”ãˆåˆã‚ã›</button>
  <button id="nextBtn" style="display:none;">æ¬¡ã¸</button>
</div>

<script src="data.js"></script>
<script>
/* =========================
   ãƒ‡ãƒ¼ã‚¿è§£æï¼ˆè¨€èªâ†’ã‚³ãƒ¼ã‚¹â†’æ–‡ï¼‰
========================= */

const langs = [];
const coursesByLang = [];
let currentLang = -1;
let currentCourse = -1;

sentenceText.split("\n").forEach(line => {
  line = line.trim();
  if (!line) return;

  if (line.startsWith("*")) {
    langs.push(line.slice(1).trim());
    coursesByLang.push([]);
    currentLang++;
    currentCourse = -1;
    return;
  }

  if (line.startsWith(">")) {
    coursesByLang[currentLang].push({
      name: line.slice(1).trim(),
      sentences: []
    });
    currentCourse++;
    return;
  }

  coursesByLang[currentLang][currentCourse].sentences.push(line);
});

/* =========================
   çŠ¶æ…‹ç®¡ç†
========================= */

let state = { lang: 0, course: 0 };
let poolJP = [], poolLang = [];
let currentWords = [], buttons = [];
let correctAnswers = [];
let questionQueue = []; // æœªæ­£è§£å•é¡Œã‚­ãƒ¥ãƒ¼

/* =========================
   é€²æ—ï¼ˆlocalStorageï¼‰
========================= */

const STORAGE_KEY = "courseProgress_v1";
let courseProgress = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");

function getProgressKey(lang, course) {
  return lang + "-" + course;
}

function getClearCount(lang, course) {
  return courseProgress[getProgressKey(lang, course)] || 0;
}

function addClear(lang, course) {
  const key = getProgressKey(lang, course);
  courseProgress[key] = getClearCount(lang, course) + 1;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(courseProgress));
}

/* =========================
   å˜èªãƒ—ãƒ¼ãƒ«æ§‹ç¯‰
========================= */

function buildWordPool() {
  const setJP = new Set();
  const setLang = new Set();

  const sentences = coursesByLang[state.lang][state.course].sentences;

  sentences.forEach(line => {
    const [lang, jpRaw] = line.split("\t");
    const jps = jpRaw.split("/");

    lang.split(" ").forEach(w => setLang.add(w));
    jps.forEach(j => j.split(" ").forEach(w => setJP.add(w)));
  });

  poolJP = [...setJP];
  poolLang = [...setLang];
}

/* =========================
   ã‚³ãƒ¼ã‚¹é–‹å§‹ï¼ˆã‚­ãƒ¥ãƒ¼ç”Ÿæˆï¼‰
========================= */

function startCourse() {
  const sentences = coursesByLang[state.lang][state.course].sentences;
  questionQueue = [...sentences].sort(() => Math.random() - 0.5);
  loadQuestion();
}

/* =========================
   å•é¡Œè¡¨ç¤ºï¼ˆã‚­ãƒ¥ãƒ¼æ–¹å¼ï¼‰
========================= */

function loadQuestion() {
  if (questionQueue.length === 0) {
    finishCourse();
    return;
  }

  const line = questionQueue[0];
  const [lang, jpRaw] = line.split("\t");
  const jps = jpRaw.split("/");

  const mode = document.getElementById("modeSelect").value;
  let questionText, answers, pool;

  if (mode === "jp2lang") {
    questionText = jps[0];
    answers = [lang];
    pool = poolLang;
  } else {
    questionText = lang;
    answers = jps;
    pool = poolJP;
  }

  correctAnswers = answers;
  currentWords = [];
  buttons = [];

  document.getElementById("result").textContent = "";
  document.getElementById("answerBox").textContent = "";
  document.getElementById("wordButtons").innerHTML = "";
  document.getElementById("checkBtn").style.display = "inline";
  document.getElementById("nextBtn").style.display = "none";
  document.getElementById("backBtn").style.display = "inline";

  document.getElementById("question").innerHTML =
    "ã€" + langs[state.lang] + " / " + coursesByLang[state.lang][state.course].name + "ã€‘<br>" + questionText;

  let words = [];
  answers.forEach(ans => ans.split(" ").forEach(w => words.push(w)));

  while (words.length < Math.min(pool.length, 12)) {
    words.push(pool[Math.floor(Math.random() * pool.length)]);
  }

  words.sort(() => Math.random() - 0.5);

  const area = document.getElementById("wordButtons");
  words.forEach(word => {
    const btn = document.createElement("button");
    btn.textContent = word;
    btn.onclick = () => {
      currentWords.push(word);
      btn.style.display = "none";
      buttons.push(btn);
      updateAnswer();
    };
    area.appendChild(btn);
  });

  document.getElementById("img").src = "pic/" + Math.floor(Math.random()*7) + ".gif";
}

/* =========================
   è§£ç­”è¡¨ç¤º
========================= */

function updateAnswer() {
  document.getElementById("answerBox").textContent = currentWords.join(" ");
}

/* =========================
   å˜èªå‰Šé™¤
========================= */

document.getElementById("backBtn").onclick = () => {
  if (currentWords.length === 0) return;
  const removed = currentWords.pop();
  const btn = buttons.find(b => b.textContent === removed && b.style.display === "none");
  if (btn) btn.style.display = "";
  updateAnswer();
};

/* =========================
   åˆ¤å®šï¼ˆã‚­ãƒ¥ãƒ¼åˆ¶å¾¡ï¼‰
========================= */

document.getElementById("checkBtn").onclick = () => {
  const userAnswer = currentWords.join(" ");
  const ok = correctAnswers.includes(userAnswer);

  const result = document.getElementById("result");

  if (ok) {
    result.textContent = "âœ… æ­£è§£";
    result.className = "correct";

    // æ­£è§£ â†’ ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤
    questionQueue.shift();
  } else {
    result.textContent = "âŒ ä¸æ­£è§£";
    result.className = "wrong";

    // ä¸æ­£è§£ â†’ å¾Œã‚ã«å›ã™
    questionQueue.push(questionQueue.shift());
  }

  document.getElementById("checkBtn").style.display = "none";
  document.getElementById("nextBtn").style.display = "inline";
};

document.getElementById("nextBtn").onclick = () => {
  loadQuestion();
};

/* =========================
   ã‚³ãƒ¼ã‚¹ã‚¯ãƒªã‚¢å‡¦ç†
========================= */

function finishCourse() {
  addClear(state.lang, state.course);
  const count = getClearCount(state.lang, state.course);

  document.getElementById("question").textContent =
    "ğŸ‰ ã‚³ãƒ¼ã‚¹ã‚¯ãƒªã‚¢ï¼ (" + count + "/2)";
  document.getElementById("wordButtons").innerHTML = "";
  document.getElementById("answerBox").textContent = "";
  document.getElementById("checkBtn").style.display = "none";
  document.getElementById("nextBtn").style.display = "none";

  updateCourseButtons();
}

/* =========================
   è¨€èªãƒ»ã‚³ãƒ¼ã‚¹é¸æŠUI
========================= */

function updateLangButtons() {
  const area = document.getElementById("langButtons");
  area.innerHTML = "";

  langs.forEach((name, i) => {
    const btn = document.createElement("button");
    btn.textContent = name;
    btn.onclick = () => selectLanguage(i);
    area.appendChild(btn);
  });
}

function updateCourseButtons() {
  const area = document.getElementById("courseButtons");
  area.innerHTML = "";

  const courses = coursesByLang[state.lang];

  courses.forEach((c, i) => {
    const btn = document.createElement("button");
    const cleared = getClearCount(state.lang, i);
    const locked = i > 0 && getClearCount(state.lang, i-1) < 2;

    btn.textContent = c.name + " (" + cleared + "/2)";
    if (locked) {
      btn.classList.add("locked");
      btn.textContent = "ğŸ”’ " + btn.textContent;
      btn.disabled = true;
    } else {
      btn.onclick = () => selectCourse(i);
    }

    area.appendChild(btn);
  });
}

function selectLanguage(idx) {
  state.lang = idx;
  document.getElementById("langSelect").style.display = "none";
  document.getElementById("courseSelect").style.display = "block";
  document.getElementById("backLangBtn").style.display = "inline";
  updateCourseButtons();
}

function selectCourse(idx) {
  state.course = idx;
  document.getElementById("courseSelect").style.display = "none";
  buildWordPool();
  startCourse();
}

/* =========================
   æˆ»ã‚‹ãƒœã‚¿ãƒ³
========================= */

document.getElementById("backLangBtn").onclick = () => {
  document.getElementById("courseSelect").style.display = "none";
  document.getElementById("langSelect").style.display = "block";
  document.getElementById("backLangBtn").style.display = "none";
  document.getElementById("question").textContent = "";
  document.getElementById("wordButtons").innerHTML = "";
};

/* =========================
   åˆæœŸåŒ–
========================= */

updateLangButtons();
</script>
</body>
</html>