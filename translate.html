<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ç¿»è¨³æ¼”ç¿’</title>
<style>
body{
  position: relative;
  width: 100%;
  text-align: center;
  margin: 0;
  padding: 0;
}
#question { font-size: 50px; margin: 5px; }
#img { position: relative; z-index: -1; transform: scale(1.75); margin: 50px; }
button {
  margin: 15px;
  font-size: 60px;
  background-color: #fefefe;
  border: 2px solid #ddd;
  border-radius: 20px;
  box-shadow: 2px 1px 2px gray
}
#answerBox {
  min-height: 100px;
  border: 1px solid #aaa;
  padding: 6px;
  margin: 30px 5px 5px 20px;
  font-size: 50px;
}
#bottomBar {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 10px;
  background: white;
  border-top: 1px solid #ccc;
  z-index: 10;
}
.correct { color: green; font-size: 50px; }
#progress { color: green; font-size: 50px; }
.wrong { color: red; font-size: 50px; }
.locked { opacity: 0.4; }
</style>
</head>
<body>
<h2>ã¨ã“ã‚ã¦ã‚“lingo</h2>
<div id=""><h2 id="progress"></h2></div>

<div id="center">
  <div><img id="img" src="pic/1.gif"></div>
  <div id="question"></div>
  <div id="result"></div>
  <div id="answerBox"></div>
  <div id="wordButtons"></div>

  <div id="langSelect"><div id="langButtons"></div></div>
  <div id="courseSelect" style="display:none;"><div id="courseButtons"></div></div>

  <button id="backBtn" style="display:none;">â† å˜èªå‰Šé™¤</button>
</div>

<div id="bottomBar">
  <button id="backLangBtn" style="display:none;">é¸æŠã«æˆ»ã‚‹</button>
  <button id="checkBtn" style="display:none;">ç­”ãˆåˆã‚ã›</button>
  <button id="nextBtn" style="display:none;">æ¬¡ã¸</button>
</div>

<script src="data.js"></script>
<script>
/* =========================
   ãƒ‡ãƒ¼ã‚¿è§£æï¼ˆè¨€èªâ†’ã‚³ãƒ¼ã‚¹â†’æ–‡ï¼‰
========================= */
let phase="lang";
const langs = [];
const coursesByLang = [];
const langDescriptions = [];
let currentLang = -1;
let currentCourse = -1;
sentenceText.split("\n").forEach(line => {
  line = line.trim();
  if (!line) return;

  if (line.startsWith("*")) {
    langs.push(line.slice(1).trim());
    coursesByLang.push([]);
    langDescriptions.push(""); // â˜…è¿½åŠ 
    currentLang++;
    currentCourse = -1;
    return;
  }

  if (line.startsWith(">")) {
    coursesByLang[currentLang].push({
      name: line.slice(1).trim(),
      sentences: []
    });
    currentCourse++;
    return;
  }

  // â˜…ã‚³ãƒ¼ã‚¹ãŒã¾ã å§‹ã¾ã£ã¦ã„ãªã‘ã‚Œã°ã€Œè¨€èªèª¬æ˜ã€
  if (currentCourse === -1) {
    langDescriptions[currentLang] += line + "\n";
  } else {
    coursesByLang[currentLang][currentCourse].sentences.push(line);
  }
});

/* =========================
   çŠ¶æ…‹ç®¡ç†
========================= */

let state = { lang: 0, course: 0 };
let poolJP = [], poolLang = [];
let currentWords = [], buttons = [];
let correctAnswers = [];
let questionQueue = []; // æœªæ­£è§£å•é¡Œã‚­ãƒ¥ãƒ¼
let total = 0;//ãã®ã‚³ãƒ¼ã‚¹ã®å•é¡Œæ•°
/* =========================
   é€²æ—ï¼ˆlocalStorageï¼‰
========================= */

const STORAGE_KEY = "courseProgress_v1";
let courseProgress = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");

function getProgressKey(lang, course) {
  return lang + "-" + course;
}

function getClearCount(lang, course) {
  return courseProgress[getProgressKey(lang, course)] || 0;
}

function addClear(lang, course) {
  const key = getProgressKey(lang, course);
  courseProgress[key] = getClearCount(lang, course) + 1;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(courseProgress));
}

/* =========================
   å˜èªãƒ—ãƒ¼ãƒ«æ§‹ç¯‰
========================= */

function buildWordPool() {
  const setJP = new Set();
  const setLang = new Set();

  const sentences = coursesByLang[state.lang][state.course].sentences;

  sentences.forEach(line => {
    const [lang, jpRaw] = line.split("\t");
    const jps = jpRaw.split("/");

    lang.split(" ").forEach(w => setLang.add(w));
    jps.forEach(j => j.split(" ").forEach(w => setJP.add(w)));
  });

  poolJP = [...setJP];
  poolLang = [...setLang];
}

/* =========================
   ã‚³ãƒ¼ã‚¹é–‹å§‹ï¼ˆã‚­ãƒ¥ãƒ¼ç”Ÿæˆï¼‰
========================= */

function startCourse() {
  phase="quiz";
  const sentences = coursesByLang[state.lang][state.course].sentences;
  questionQueue = [...sentences].sort(() => Math.random() - 0.5);
  total = questionQueue.length;
  loadQuestion();
}

/* =========================
   å•é¡Œè¡¨ç¤ºï¼ˆã‚­ãƒ¥ãƒ¼æ–¹å¼ï¼‰
========================= */

function normalize(str) {
  return str.replace(/\s+/g, " ").trim();
}

function loadQuestion() {
  if (questionQueue.length === 0) {
    finishCourse();
    return;
  }
  progress();
  const line = questionQueue[0];
  const [lang, jpRaw] = line.split("\t");
  const jps = jpRaw.split("/");

  let mode = "jp2lang"
  if (getClearCount(state.lang, state.course)%2==0){mode = "lang2jp"}
  
  let questionText, answers, pool;
  
  if (mode === "jp2lang") {
    questionText = jps[0];
    answers = [lang];
    pool = poolLang;
  } else {
    questionText = lang;
    answers = jps;
    pool = poolJP;
  }
  

  correctAnswers = answers;
  currentWords = [];
  buttons = [];
  document.getElementById("progress").style.display = "inline";
  document.getElementById("result").textContent = "";
  document.getElementById("answerBox").textContent = "";
  document.getElementById("wordButtons").innerHTML = "";
  document.getElementById("checkBtn").style.display = "inline";
  document.getElementById("nextBtn").style.display = "none";
  document.getElementById("backBtn").style.display = "inline";

  document.getElementById("question").innerHTML =
    "ã€" + langs[state.lang] + " / " + coursesByLang[state.lang][state.course].name + "ã€‘<br>" + questionText;

  let words = [];
  answers.forEach(ans =>
  ans.split(" ")
    .map(w => w.trim())
    .filter(w => w !== "")
    .forEach(w => words.push(w))
);

while (words.length < Math.min(pool.length, 12)) {
  const w = pool[Math.floor(Math.random() * pool.length)].trim();
  if (w !== "") words.push(w);
}

  words.sort(() => Math.random() - 0.5);

  const area = document.getElementById("wordButtons");
  words.forEach(word => {
    const btn = document.createElement("button");
    btn.textContent = word;
    btn.onclick = () => {
      currentWords.push(word);
      btn.style.display = "none";
      buttons.push(btn);
      updateAnswer();
    };
    area.appendChild(btn);
  });

  document.getElementById("img").src = "pic/" + Math.floor(Math.random()*7) + ".gif";
  sizeChange()
}

/* =========================
   è§£ç­”è¡¨ç¤º
========================= */

function updateAnswer() {
  document.getElementById("answerBox").textContent = currentWords.join(" ");
}

/* =========================
   å˜èªå‰Šé™¤
========================= */

document.getElementById("backBtn").onclick = () => {
  if (currentWords.length === 0) return;
  const removed = currentWords.pop();
  const btn = buttons.find(b => b.textContent === removed && b.style.display === "none");
  if (btn) btn.style.display = "";
  updateAnswer();
};

/* =========================
   åˆ¤å®šï¼ˆã‚­ãƒ¥ãƒ¼åˆ¶å¾¡ï¼‰
========================= */

document.getElementById("checkBtn").onclick = () => {
  const userAnswer = normalize(currentWords.join(" "));

  const ok = correctAnswers.some(ans => normalize(ans) === userAnswer);

  const result = document.getElementById("result");

  if (ok) {
    result.textContent = "âœ… æ­£è§£";
    result.className = "correct";
    questionQueue.shift();
  } else {
    result.textContent =
      "âŒ ä¸æ­£è§£\næ­£è§£: " + correctAnswers.join(" / ");
    result.className = "wrong";
    questionQueue.push(questionQueue.shift());
  }

  progress();
  document.getElementById("checkBtn").style.display = "none";
  document.getElementById("nextBtn").style.display = "inline";
};

document.getElementById("nextBtn").onclick = () => {
  loadQuestion();
};

/* =========================
   ã‚³ãƒ¼ã‚¹ã‚¯ãƒªã‚¢å‡¦ç†
========================= */

function finishCourse() {
  addClear(state.lang, state.course);
  const count = getClearCount(state.lang, state.course);

  document.getElementById("question").textContent =
    "ğŸ‰ ã‚³ãƒ¼ã‚¹ã‚¯ãƒªã‚¢ï¼ (" + count + "/2)";
  document.getElementById("wordButtons").innerHTML = "";
  document.getElementById("result").textContent="";
  document.getElementById("answerBox").textContent = "";
  document.getElementById("checkBtn").style.display = "none";
  document.getElementById("nextBtn").style.display = "none";
document.getElementById("backBtn").style.display = "none";
}

/* =========================
   è¨€èªãƒ»ã‚³ãƒ¼ã‚¹é¸æŠUI
========================= */

function updateLangButtons() {
phase="lang";
  const area = document.getElementById("langButtons");
  area.innerHTML = "";
  langs.forEach((name, i) => {
    const btn = document.createElement("button");
    btn.textContent = name;
    btn.onclick = () => selectLanguage(i);
    area.appendChild(btn);
  });
  sizeChange()
}

function updateCourseButtons() {
phase="course";
  const area = document.getElementById("courseButtons");
  area.innerHTML = "";

  const courses = coursesByLang[state.lang];
  courses.forEach((c, i) => {
    const btn = document.createElement("button");
    const cleared = getClearCount(state.lang, i);
    const locked = i > 0 && getClearCount(state.lang, i-1) < 2;
    document.getElementById("question").innerHTML =
    "ã€" + langs[state.lang] + "ã€‘<br>" +
    langDescriptions[state.lang].replace(/\n/g, "<br>");
    document.getElementById("img").style.display="none";
  document.getElementById("answerBox").style.minHeight="10px";
    btn.textContent = c.name + " (" + cleared + "/2)";
    if (locked) {
      btn.classList.add("locked");
      btn.textContent = "ğŸ”’ " + btn.textContent;
      btn.disabled = true;
    } else {
      btn.onclick = () => selectCourse(i);
    }

    area.appendChild(btn);
  sizeChange()
  });
}

function selectLanguage(idx) {
  state.lang = idx;
  document.getElementById("langSelect").style.display = "none";
  document.getElementById("courseSelect").style.display = "block";
  document.getElementById("backLangBtn").style.display = "inline";
  updateCourseButtons();
}

function selectCourse(idx) {
  state.course = idx;
  document.getElementById("courseSelect").style.display = "none";
  document.getElementById("img").style.display="inline";
  document.getElementById("answerBox").style.minHeight="100px";
  buildWordPool();
  startCourse();
}

/* =========================
   æˆ»ã‚‹ãƒœã‚¿ãƒ³
========================= */

document.getElementById("backLangBtn").onclick = () => {
  // å…¨ä½“ã®å…±é€šåˆæœŸåŒ–ï¼ˆä¸€æ—¦éš ã™ã€ä¸­èº«ã‚’æ¶ˆã™ï¼‰
  document.getElementById("checkBtn").style.display = "none";
  document.getElementById("nextBtn").style.display = "none";
  document.getElementById("backBtn").style.display = "none";
  document.getElementById("progress").style.display = "none";
  document.getElementById("question").textContent = "";
  document.getElementById("wordButtons").innerHTML = "";

  if (phase === "quiz") {
    // ã‚¯ã‚¤ã‚ºä¸­ãªã‚‰ã‚³ãƒ¼ã‚¹é¸æŠç”»é¢ã«æˆ»ã™
    phase = "course";
    document.getElementById("courseSelect").style.display = "block";
    document.getElementById("langSelect").style.display = "none";
    updateCourseButtons();
  } 
  else if (phase === "course") {
    // ã‚³ãƒ¼ã‚¹é¸æŠä¸­ãªã‚‰è¨€èªé¸æŠç”»é¢ã«æˆ»ã™
    phase = "lang";
    document.getElementById("courseSelect").style.display = "none";
    document.getElementById("langSelect").style.display = "block";
    document.getElementById("backLangBtn").style.display = "none"; // ä¸€ç•ªè¦ªã«æˆ»ã‚‹ã®ã§æˆ»ã‚‹ãƒœã‚¿ãƒ³è‡ªä½“æ¶ˆã™
    updateLangButtons();
  }
};


function progress(){
 var txt ="é€²æ—:";
 var q = questionQueue.length;
 for (let i=0;i<10;i++){
  if(1-q/total>i/10){
   txt = txt+"â– "
  }else{
   txt=txt+"â–¡"  
  }
 }
  txt=txt+(100-Math.floor(q/total*100))+"%"
  document.getElementById("progress").textContent = txt;
}

/* =========================
   åˆæœŸåŒ–
========================= */
addEventListener("load", (event) => {sizeChange();});
  
function sizeChange(){
  
  if (screen.width > screen.height){
  var size = "30px"
  document.getElementById("question").style.fontSize = size; document.getElementById("answerBox").style.fontSize = size; document.getElementById("wordButtons").style.fontSize = size;
  document.getElementById("center").style.top="0%";
  document.querySelectorAll('button').forEach(btn => {
   btn.style.fontSize= size; 
   btn.style.margin= "5px"; 
  });
  document.getElementById("result").style.fontSize = size;
  }else{
var size = "68px"
 document.getElementById("question").style.fontSize = size; document.getElementById("answerBox").style.fontSize = size;
document.getElementById("wordButtons").style.fontSize = size;  document.getElementById("center").style.top="50%";
  document.querySelectorAll('button').forEach(btn => {btn.style.fontSize= size; btn.style.margin= "20px"; });
  document.getElementById("result").style.fontSize = size;
  }
  if (screen.height < 500 || screen.width>screen.height){
   document.getElementById("img").style.transform= "scale(1)";
   document.getElementById("img").style.margin= "0px";
  }else{
    document.getElementById("img").style.transform= "scale(1.75)";
   document.getElementById("img").style.margin= "50px";
  }
  if (phase === "course"){
    if (screen.width>screen.height){
      document.getElementById("question").style.fontSize="20px";
    }else{
      document.getElementById("question").style.fontSize="40px";
    }
  }
}
  
window.addEventListener("resize", sizeChange);
updateLangButtons();
</script>
</body>
</html>
